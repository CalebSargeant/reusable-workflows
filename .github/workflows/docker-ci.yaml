name: Docker Bake CI

# Dedicated workflow for PR container builds with path filtering
# This runs on pull requests and skips builds when only non-container files change

on:
  workflow_call:
    inputs:
      container_paths:
        description: 'Paths that trigger container builds (multiline string, one glob pattern per line). Uses dorny/paths-filter syntax.'
        required: false
        type: string
        default: |
          **
          !.github/**
          !*.md
          !docs/**
          !LICENSE
          !.gitignore
      bake_file:
        description: 'Path to docker-bake file'
        required: false
        type: string
        default: 'docker-bake.hcl'
      bake_target:
        description: 'Docker Bake target to build'
        required: false
        type: string
        default: 'default'
      push_target:
        description: 'Docker Bake target for push (if different from build target)'
        required: false
        type: string
        default: ''
      image_name:
        description: 'Docker image name (without registry/org prefix). Defaults to bake_target if not specified.'
        required: false
        type: string
        default: ''
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      push:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: true
      registry:
        description: 'Container registry'
        required: false
        type: string
        default: 'ghcr.io'
      runner:
        description: 'GitHub runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
      force_version:
        description: 'Force specific version (overrides automatic detection)'
        required: false
        type: string
        default: ''
      buildx_vars:
        description: 'Additional environment variables for docker/bake-action (lines like KEY=VALUE)'
        required: false
        type: string
        default: ''
    outputs:
      version:
        description: 'The version tag that was built. This will be empty if build_skipped == "true" (no container build was run).'
        value: ${{ jobs.ci-build.outputs.version }}
      image:
        description: 'The full image name (without tag). This will be empty if build_skipped == "true" (no container build was run).'
        value: ${{ jobs.ci-build.outputs.image }}
      image_with_tag:
        description: 'The full image name with tag. This will be empty if build_skipped == "true" (no container build was run).'
        value: ${{ jobs.ci-build.outputs.image_with_tag }}
      build_skipped:
        description: 'Whether the build was skipped due to path filtering. Callers should check this before using version/image outputs.'
        value: ${{ jobs.check-changes.outputs.should_skip }}
    secrets:
      registry_username:
        required: false
      registry_password:
        required: false

jobs:
  check-changes:
    name: Check Changed Files
    runs-on: ${{ inputs.runner }}
    permissions:
      pull-requests: read
    outputs:
      container_changed: ${{ steps.filter.outputs.container }}
      should_skip: ${{ steps.filter.outputs.container != 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Check for container-related changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            container:
              ${{ inputs.container_paths }}

      - name: Build decision
        run: |
          if [ "${{ steps.filter.outputs.container }}" == "true" ]; then
            echo "✓ Container-related files changed - build will proceed"
          else
            echo "ℹ️ No container-related files changed - build will be skipped"
            echo ""
            echo "To trigger a build, modify files matching the container_paths filter."
            echo "Current filter patterns:"
            echo "${{ inputs.container_paths }}" | sed 's/^/  /'
          fi

  ci-build:
    name: Container Build (CI)
    needs: check-changes
    if: needs.check-changes.outputs.container_changed == 'true'
    runs-on: ${{ inputs.runner }}
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      image: ${{ steps.image.outputs.full_name }}
      image_with_tag: ${{ inputs.registry }}/${{ steps.image.outputs.full_name }}:${{ steps.version.outputs.version }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: --debug

      - name: Log in to Container Registry
        if: inputs.push
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ inputs.registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          VERSION="pr-${{ github.event.pull_request.number }}"

          # Override with force_version if provided
          if [[ -n "${{ inputs.force_version }}" ]]; then
            VERSION="${{ inputs.force_version }}"
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building version: ${VERSION}"

      - name: Set image name
        id: image
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          # Use image_name if provided, otherwise fall back to bake_target
          IMAGE_NAME="${{ inputs.image_name }}"
          if [ -z "${IMAGE_NAME}" ]; then
            IMAGE_NAME="${{ inputs.bake_target }}"
          fi
          IMAGE_LOWER=$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
          echo "full_name=${OWNER_LOWER}/${IMAGE_LOWER}" >> "$GITHUB_OUTPUT"

      - name: Export build variables
        if: inputs.buildx_vars != ''
        run: |
          # Export each KEY=VALUE pair as environment variable for docker/bake-action
          # Bake automatically picks up env vars matching variable names in the HCL file
          printf '%s\n' "${{ inputs.buildx_vars }}" >> "$GITHUB_ENV"

      - name: Build with Docker Bake
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c # v6.9.0
        with:
          files: |
            ${{ inputs.bake_file }}
          targets: ${{ inputs.bake_target }}
          push: ${{ inputs.push }}
          set: |
            *.tags=${{ inputs.registry }}/${{ steps.image.outputs.full_name }}:${{ steps.version.outputs.version }}
            *.tags=${{ inputs.registry }}/${{ steps.image.outputs.full_name }}:latest
            *.cache-from=type=gha,scope=buildkit-${{ inputs.image_name || inputs.bake_target }}
            *.cache-from=type=gha,scope=buildkit-${{ inputs.image_name || inputs.bake_target }}-${{ github.ref_name }}
            *.cache-to=type=gha,mode=max,scope=buildkit-${{ inputs.image_name || inputs.bake_target }}-${{ github.ref_name }}
            *.cache-to=type=inline
        env:
          VERSION: ${{ steps.version.outputs.version }}
          REGISTRY: ${{ inputs.registry }}
          IMAGE_NAME: ${{ steps.image.outputs.full_name }}
          PLATFORMS: ${{ inputs.platforms }}
