name: Docker Bake CI

# Dedicated workflow for PR container builds with path filtering
# This runs on pull requests and skips builds when only non-container files change

on:
  workflow_call:
    inputs:
      container_paths:
        description: 'Paths that trigger container builds (multiline string, one glob pattern per line). Uses dorny/paths-filter syntax.'
        required: false
        type: string
        default: |
          Dockerfile
          Dockerfile.*
          **/Dockerfile
          **/Dockerfile.*
          docker-bake.hcl
          docker-compose*.yml
          docker-compose*.yaml
          .dockerignore
          src/**
          app/**
          cmd/**
          pkg/**
          internal/**
          lib/**
          bin/**
          scripts/**
          go.mod
          go.sum
          package.json
          package-lock.json
          yarn.lock
          pnpm-lock.yaml
          requirements.txt
          pyproject.toml
          poetry.lock
          Pipfile
          Pipfile.lock
          Cargo.toml
          Cargo.lock
          Gemfile
          Gemfile.lock
          *.csproj
          *.fsproj
          *.vbproj
          *.sln
          nuget.config
          Directory.Build.props
          Directory.Packages.props
          global.json
          composer.json
          composer.lock
          pom.xml
          build.gradle
          build.gradle.kts
          settings.gradle
          settings.gradle.kts
          mix.exs
          mix.lock
          pubspec.yaml
          pubspec.lock
          *.go
          *.py
          *.js
          *.ts
          *.jsx
          *.tsx
          *.rb
          *.rs
          *.cs
          *.fs
          *.vb
          *.sh
          *.bash
          *.zsh
          *.php
          *.java
          *.kt
          *.kts
          *.scala
          *.ex
          *.exs
          *.erl
          *.hrl
          *.swift
          *.m
          *.mm
          *.c
          *.cpp
          *.cc
          *.cxx
          *.h
          *.hpp
          *.hxx
          *.lua
          *.pl
          *.pm
          *.r
          *.R
          *.dart
      bake_file:
        description: 'Path to docker-bake file'
        required: false
        type: string
        default: 'docker-bake.hcl'
      bake_target:
        description: 'Docker Bake target to build'
        required: false
        type: string
        default: 'default'
      push_target:
        description: 'Docker Bake target for push (if different from build target)'
        required: false
        type: string
        default: ''
      image_name:
        description: 'Docker image name (without registry/org prefix). Defaults to bake_target if not specified.'
        required: false
        type: string
        default: ''
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      push:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: true
      registry:
        description: 'Container registry'
        required: false
        type: string
        default: 'ghcr.io'
      runner:
        description: 'GitHub runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
      force_version:
        description: 'Force specific version (overrides automatic detection)'
        required: false
        type: string
        default: ''
      buildx_vars:
        description: 'Additional environment variables for docker/bake-action (lines like KEY=VALUE)'
        required: false
        type: string
        default: ''
    outputs:
      version:
        description: 'The version tag that was built. This will be empty if build_skipped == "true" (no container build was run).'
        value: ${{ jobs.ci-build.outputs.version }}
      image:
        description: 'The full image name (without tag). This will be empty if build_skipped == "true" (no container build was run).'
        value: ${{ jobs.ci-build.outputs.image }}
      image_with_tag:
        description: 'The full image name with tag. This will be empty if build_skipped == "true" (no container build was run).'
        value: ${{ jobs.ci-build.outputs.image_with_tag }}
      build_skipped:
        description: 'Whether the build was skipped due to path filtering. Callers should check this before using version/image outputs.'
        value: ${{ jobs.ci-build.outputs.build_skipped }}
    secrets:
      registry_username:
        required: false
      registry_password:
        required: false

jobs:
  ci-build:
    name: Container Build (CI)
    runs-on: ${{ inputs.runner }}
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      image: ${{ steps.image.outputs.full_name }}
      image_with_tag: ${{ steps.image-with-tag.outputs.image_with_tag }}
      build_skipped: ${{ steps.filter.outputs.container != 'true' }}
    permissions:
      contents: read
      packages: write
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Create paths filter config
        id: create-filter
        run: |
          # Create a properly formatted YAML filter file
          # The container_paths input contains plain glob patterns, one per line
          # We convert them to YAML list format with proper quoting

          echo "container:" > "$RUNNER_TEMP/paths-filter.yml"

          # Read each pattern and format as YAML list item
          while IFS= read -r pattern || [[ -n "$pattern" ]]; do
            # Trim leading/trailing whitespace from the pattern
            pattern=$(echo "$pattern" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            # Skip empty lines (after trimming)
            [[ -z "$pattern" ]] && continue
            # Always quote patterns to safely handle YAML special characters (e.g. !, *, [, {)
            echo "  - '$pattern'" >> "$RUNNER_TEMP/paths-filter.yml"
          done <<< "${{ inputs.container_paths }}"

          echo "Filter config:"
          cat "$RUNNER_TEMP/paths-filter.yml"

      - name: Check for container-related changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: ${{ runner.temp }}/paths-filter.yml

      - name: Build decision
        run: |
          if [ "${{ steps.filter.outputs.container }}" == "true" ]; then
            echo "✓ Container-related files changed - build will proceed"
          else
            echo "ℹ️ No container-related files changed - build will be skipped"
            echo ""
            echo "To trigger a build, modify files matching the container_paths filter."
            echo "Current filter patterns:"
            echo "${{ inputs.container_paths }}" | sed 's/^/  /'
          fi

      - name: Set up QEMU
        if: steps.filter.outputs.container == 'true'
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        if: steps.filter.outputs.container == 'true'
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: --debug

      - name: Log in to Container Registry
        if: steps.filter.outputs.container == 'true' && inputs.push
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ inputs.registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        if: steps.filter.outputs.container == 'true'
        id: version
        run: |
          VERSION="pr-${{ github.event.pull_request.number }}"

          # Override with force_version if provided
          if [[ -n "${{ inputs.force_version }}" ]]; then
            VERSION="${{ inputs.force_version }}"
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building version: ${VERSION}"

      - name: Set image name
        if: steps.filter.outputs.container == 'true'
        id: image
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          # Use image_name if provided, otherwise fall back to bake_target
          IMAGE_NAME="${{ inputs.image_name }}"
          if [ -z "${IMAGE_NAME}" ]; then
            IMAGE_NAME="${{ inputs.bake_target }}"
          fi
          IMAGE_LOWER=$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
          echo "full_name=${OWNER_LOWER}/${IMAGE_LOWER}" >> "$GITHUB_OUTPUT"

      - name: Set image with tag
        if: steps.filter.outputs.container == 'true'
        id: image-with-tag
        run: |
          echo "image_with_tag=${{ inputs.registry }}/${{ steps.image.outputs.full_name }}:${{ steps.version.outputs.version }}" >> "$GITHUB_OUTPUT"

      - name: Export build variables
        if: steps.filter.outputs.container == 'true' && inputs.buildx_vars != ''
        run: |
          # Export each KEY=VALUE pair as environment variable for docker/bake-action
          # Bake automatically picks up env vars matching variable names in the HCL file
          printf '%s\n' "${{ inputs.buildx_vars }}" >> "$GITHUB_ENV"

      - name: Build with Docker Bake
        if: steps.filter.outputs.container == 'true'
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c # v6.9.0
        with:
          files: |
            ${{ inputs.bake_file }}
          targets: ${{ inputs.bake_target }}
          push: ${{ inputs.push }}
          set: |
            *.tags=${{ inputs.registry }}/${{ steps.image.outputs.full_name }}:${{ steps.version.outputs.version }}
            *.tags=${{ inputs.registry }}/${{ steps.image.outputs.full_name }}:latest
            *.cache-from=type=gha,scope=buildkit-${{ inputs.image_name || inputs.bake_target }}
            *.cache-from=type=gha,scope=buildkit-${{ inputs.image_name || inputs.bake_target }}-${{ github.ref_name }}
            *.cache-to=type=gha,mode=max,scope=buildkit-${{ inputs.image_name || inputs.bake_target }}-${{ github.ref_name }}
            *.cache-to=type=inline
        env:
          VERSION: ${{ steps.version.outputs.version }}
          REGISTRY: ${{ inputs.registry }}
          IMAGE_NAME: ${{ steps.image.outputs.full_name }}
          PLATFORMS: ${{ inputs.platforms }}
