name: Kustomize Lint

on:
  workflow_call:
    inputs:
      runner:
        type: string
        description: 'The runner to use for the job'
        default: ubuntu-latest
        required: false
      k8s_directory:
        type: string
        description: 'Directory containing Kustomize files'
        required: false
        default: './k8s'
      kustomize_version:
        type: string
        description: 'Kustomize version to use'
        required: false
        default: '5.8.1'
      kubernetes_version:
        type: string
        description: 'Kubernetes version for validation (e.g., 1.32.0)'
        required: false
        default: '1.32.0'
      skip_yamllint:
        type: boolean
        description: 'Skip YAML linting'
        required: false
        default: false
      fail_on_yamllint:
        type: boolean
        description: 'Fail the workflow if yamllint finds issues'
        required: false
        default: false
      skip_kubeconform:
        type: boolean
        description: 'Skip kubeconform validation'
        required: false
        default: false
      skip_kubescore:
        type: boolean
        description: 'Skip kube-score validation'
        required: false
        default: false
      strict_validation:
        type: boolean
        description: 'Enable strict validation in kubeconform'
        required: false
        default: true

permissions:
  contents: read
  pull-requests: read

jobs:
  # Lint and validate Kustomize files
  lint:
    runs-on: ${{ inputs.runner }}
    steps:
      - name: 'Checkout'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: 'Normalize k8s directory path'
        id: normalize-path
        run: |
          K8S_DIR="${{ inputs.k8s_directory }}"
          K8S_DIR="${K8S_DIR#./}"
          echo "normalized_path=${K8S_DIR}" >> "$GITHUB_OUTPUT"

      - name: 'Check for changes in k8s directory'
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            k8s:
              - '${{ steps.normalize-path.outputs.normalized_path }}/**'

      - name: 'Exit early if no changes'
        if: steps.filter.outputs.k8s != 'true'
        run: |
          echo "âœ“ No changes detected in ${{ inputs.k8s_directory }}, skipping linting"
          exit 0

      - name: 'Setup Kustomize'
        if: steps.filter.outputs.k8s == 'true'
        run: |
          KUSTOMIZE_VERSION="${{ inputs.kustomize_version }}"
          echo "Installing kustomize v${KUSTOMIZE_VERSION}"
          curl -sLO "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${KUSTOMIZE_VERSION}/kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          tar xzf "kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          sudo mv kustomize /usr/local/bin/
          rm "kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          kustomize version

      - name: 'Setup Python for yamllint'
        if: steps.filter.outputs.k8s == 'true' && !inputs.skip_yamllint
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.12'

      - name: 'Install yamllint'
        if: steps.filter.outputs.k8s == 'true' && !inputs.skip_yamllint
        run: pip install yamllint==1.35.1

      - name: 'Lint YAML files'
        if: steps.filter.outputs.k8s == 'true' && !inputs.skip_yamllint
        run: |
          # yamllint can be strict; by default we allow it to fail with warnings
          # Set fail_on_yamllint: true to make this a hard failure
          if [ "${{ inputs.fail_on_yamllint }}" == "true" ]; then
            yamllint "${{ inputs.k8s_directory }}/"
          else
            yamllint "${{ inputs.k8s_directory }}/" || echo "::warning::YAML linting found issues but continuing..."
          fi

      - name: 'Build Kustomize manifests'
        if: steps.filter.outputs.k8s == 'true'
        id: kustomize-build
        run: |
          # Find all kustomization.yaml files and build them
          find "${{ inputs.k8s_directory }}" \( -name 'kustomization.yaml' -o -name 'kustomization.yml' \) | while read -r kustomization_file; do
            kustomization_dir=$(dirname "$kustomization_file")
            echo "Building Kustomize in: $kustomization_dir"
            kustomize build "$kustomization_dir" >> rendered-manifests.yaml
            echo "---" >> rendered-manifests.yaml
          done

          if [ ! -s rendered-manifests.yaml ]; then
            echo "::error::No Kustomize manifests were built. Check if kustomization.yaml exists in ${{ inputs.k8s_directory }}"
            exit 1
          fi

          echo "Successfully built Kustomize manifests"

      - name: 'Validate with kubeconform'
        if: steps.filter.outputs.k8s == 'true' && !inputs.skip_kubeconform
        run: |
          STRICT_FLAG=""
          if [ "${{ inputs.strict_validation }}" == "true" ]; then
            STRICT_FLAG="-strict"
          fi

          cat rendered-manifests.yaml | docker run --rm -i \
            ghcr.io/yannh/kubeconform:v0.6.7-alpine \
            $STRICT_FLAG \
            -summary \
            -kubernetes-version ${{ inputs.kubernetes_version }}

      - name: 'Validate with kube-score'
        if: steps.filter.outputs.k8s == 'true' && !inputs.skip_kubescore
        run: |
          # kube-score expects version in vN.NN format, not N.NN.N
          K8S_VERSION_SHORT=$(echo "${{ inputs.kubernetes_version }}" | cut -d. -f1-2)
          if [[ ! "$K8S_VERSION_SHORT" =~ ^v ]]; then
            K8S_VERSION_SHORT="v${K8S_VERSION_SHORT}"
          fi

          cat rendered-manifests.yaml | docker run --rm -i \
            zegl/kube-score:v1.19.0 \
            score - \
            --kubernetes-version "$K8S_VERSION_SHORT" \
            --color always || echo "::warning::kube-score found issues but continuing..."
