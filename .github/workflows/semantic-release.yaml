#What Each Repository Needs
#
#For any repository to use this semantic release workflow:
#
#1. pyproject.toml with semantic release configuration
#2. Caller workflow (see below)

#3. Setup GitHub App:

#1. Create a GitHub App:
#â—¦  Go to GitHub Settings â†’ Developer settings â†’ GitHub Apps â†’ New App
#â—¦  Name: "Platform1 Release Bot"
#â—¦  Homepage URL: Your organization URL
#â—¦  Permissions:
#â–ª  Repository permissions:
#â–ª  Contents: Read and write
#â–ª  Metadata: Read
#â–ª  Pull requests: Read (if you want to analyze PR commits)
#â–ª  Account permissions: None
#2. Generate private key:
#â—¦  After creating the app, generate a private key
#â—¦  Download the .pem file
#3. Install the app:
#â—¦  Install it on your repositories or organization
#â—¦  Note the App ID
#
#Add Secrets to Your Repository
#
#1. Go to your repository: https://github.com/platform1/platform1-infra
#2. Click Settings â†’ Secrets and variables â†’ Actions
#3. Click "New repository secret" and add these two secrets:
#
#Secret 1:
#â€¢  Name: RELEASE_APP_ID
#â€¢  Value: 2019620
#
#Secret 2:
#â€¢  Name: RELEASE_APP_PRIVATE_KEY
#â€¢  Value: Copy and paste the entire private key contents:

name: Semantic Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  workflow_call:
    inputs:
      bump:
        description: 'Force version bump type (for workflow_dispatch)'
        required: false
        type: string
        default: ''
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      working_directory:
        description: 'Working directory for the semantic release'
        required: false
        type: string
        default: '.'
    outputs:
      version:
        description: "The newly released version"
        value: ${{ jobs.semantic-release.outputs.new_version }}
      released:
        description: "Whether a new release was published"
        value: ${{ jobs.semantic-release.outputs.released }}
      tag:
        description: "The Git tag for the release"
        value: ${{ jobs.semantic-release.outputs.tag }}
    secrets:
      RELEASE_TOKEN:
        description: 'GitHub token with permissions to push to protected branches'
        required: false
      APP_ID:
        description: 'GitHub App ID for authentication'
        required: false
      APP_PRIVATE_KEY:
        description: 'GitHub App private key for authentication'
        required: false

# default: least privileged permissions across all jobs
permissions:
  contents: read

jobs:
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    concurrency:
      group: semantic-release-${{ github.repository }}-${{ github.ref_name }}
      cancel-in-progress: false
    permissions:
      contents: write      # Required to push commits and tags
      id-token: write      # Required for GitHub's OIDC token
    outputs:
      new_version: ${{ steps.release.outputs.version }}
      released: ${{ steps.release.outputs.released }}
      tag: ${{ steps.release.outputs.tag }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
        continue-on-error: true
          
      - name: Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0  # Full history needed for semantic release
          # Use GitHub App token, PAT, or default GITHUB_TOKEN
          token: ${{ steps.app-token.outputs.token || secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      
      - name: Validate required secrets
        id: validate-secrets
        env:
          APP_TOKEN_OUTCOME: ${{ steps.app-token.outcome }}
        shell: bash
        run: |
          # Check if GitHub App token generation failed (indicates missing secrets)
          if [[ "${APP_TOKEN_OUTCOME}" == "failure" ]]; then
            echo "âŒ ERROR: GitHub App token generation failed!"
            echo "Please configure authentication secrets:"
            echo "  1. APP_ID + APP_PRIVATE_KEY (GitHub App authentication)"
            echo "  2. OR RELEASE_TOKEN (Personal Access Token)"
            echo ""
            echo "Instructions:"
            echo "  - Go to repository Settings â†’ Secrets and variables â†’ Actions"
            echo "  - Click 'New repository secret' and add the required secret"
            exit 1
          fi
          
          if [[ "${APP_TOKEN_OUTCOME}" == "success" ]]; then
            echo "âœ… GitHub App authentication configured"
          else
            echo "â„¹ï¸ Using RELEASE_TOKEN or GITHUB_TOKEN for authentication"
          fi
          
      - name: Force branch to workflow sha
        run: |
          git reset --hard ${{ github.sha }}

      - name: Change to working directory
        if: inputs.working_directory != '.'
        env:
          WORKING_DIR: ${{ inputs.working_directory }}
        run: |
          cd "${WORKING_DIR}"

      - name: Python Semantic Release
        id: release
        uses: python-semantic-release/python-semantic-release@4d4cb0ab842247caea1963132c242c62aab1e4d5 # v10.4.1
        with:
          github_token: ${{ steps.app-token.outputs.token || secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
          git_committer_name: "github-actions[bot]"
          git_committer_email: "actions@users.noreply.github.com"
          # Force version bump for manual dispatch
          force: ${{ inputs.bump }}
          # Skip build since this is infrastructure, not a Python package
          build: false
          # Enable changelog generation
          changelog: true
          # Enable VCS (GitHub) release creation
          vcs_release: true
          # Enable commits if we have elevated permissions (App or PAT)
          commit: true
          # Working directory
          directory: ${{ inputs.working_directory }}
          # Increase verbosity for debugging
          verbosity: 2

      - name: Output release info
        if: steps.release.outputs.released == 'true'
        run: |
          echo "ðŸŽ‰ New release published: ${{ steps.release.outputs.tag }}"
          echo "ðŸ“ Release notes available at: ${{ steps.release.outputs.link }}"
          echo "ðŸ“¦ This is a deployment version tag for the infrastructure"
          echo "ðŸ³ Docker images will be built and pushed by the docker-release workflow"
          echo "â„¹ï¸ To build Docker images, go to Actions > Docker Release Build and run manually or wait for the release event"
          

# Caller Workflow Example:
#name: Semantic Release
#
#on:
#  push:
#    branches:
#      - main      # Production releases only
#    paths-ignore:
#      - 'dockerfiles/**'  # Docker changes don't trigger releases
#      - '**.md'           # Documentation changes don't trigger releases
#      - '.github/workflows/docker-*.yaml'  # Docker workflow changes don't trigger releases
#  workflow_dispatch:
#    inputs:
#      bump:
#        description: 'Version bump type'
#        required: false
#        default: 'patch'
#        type: choice
#        options:
#          - patch
#          - minor
#          - major
#
#jobs:
#  semantic-release:
#    name: Semantic Release
#    uses: tengen-systems/platform1-workflows/.github/workflows/semantic-release.yaml@main
#    with:
#      bump: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.bump || '' }}
#      working_directory: '.'
#    secrets:
#      RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}
#
#  post-release:
#    name: Post Release Actions
#    runs-on: ubuntu-latest
#    needs: semantic-release
#    if: needs.semantic-release.outputs.released == 'true'
#    steps:
#      - name: Output release info
#        run: |
#          echo "ðŸŽ‰ New release published: ${{ needs.semantic-release.outputs.tag }}"
#          echo "ðŸ“ Version: ${{ needs.semantic-release.outputs.version }}"
#          echo "ðŸ“¦ This is a deployment version tag for the infrastructure"
#          echo "ðŸ³ Docker images will be built and pushed by the docker-release workflow"
#          echo "â„¹ï¸ To build Docker images, go to Actions > Docker Release Build and run manually or wait for the release event"
