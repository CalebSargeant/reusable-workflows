#What Each Repository Needs
#
#For any repository to use this semantic release workflow:
#
#1. pyproject.toml with semantic release configuration
#2. Caller workflow (see below)

#3. Setup GitHub App:

#1. Create a GitHub App:
#◦  Go to GitHub Settings → Developer settings → GitHub Apps → New App
#◦  Name: "Org Release Bot"
#◦  Homepage URL: Your organization URL
#◦  Permissions:
#▪  Repository permissions:
#▪  Contents: Read and write
#▪  Metadata: Read
#▪  Pull requests: Read (if you want to analyze PR commits)
#▪  Account permissions: None
#2. Generate private key:
#◦  After creating the app, generate a private key
#◦  Download the .pem file
#3. Install the app:
#◦  Install it on your repositories or organization
#◦  Note the App ID
#
#Add Secrets to Your Repository
#
#1. Go to your repository: https://github.com/org/repo
#2. Click Settings → Secrets and variables → Actions
#3. Click "New repository secret" and add these two secrets:
#
#Secret 1:
#•  Name: SEMANTIC_RELEASE_APP_ID
#•  Value: 2019620
#
#Secret 2:
#•  Name: SEMANTIC_RELEASE_APP_PRIVATE_KEY
#•  Value: Copy and paste the entire private key contents:

name: Semantic Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  workflow_call:
    inputs:
      bump:
        description: 'Force version bump type (for workflow_dispatch)'
        required: false
        type: string
        default: ''
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      working_directory:
        description: 'Working directory for the semantic release'
        required: false
        type: string
        default: '.'
    outputs:
      version:
        description: "The newly released version"
        value: ${{ jobs.semantic-release.outputs.new_version }}
      released:
        description: "Whether a new release was published"
        value: ${{ jobs.semantic-release.outputs.released }}
      tag:
        description: "The Git tag for the release"
        value: ${{ jobs.semantic-release.outputs.tag }}
    secrets:
      SEMANTIC_RELEASE_TOKEN:
        description: 'GitHub token with permissions to push to protected branches'
        required: false
      SEMANTIC_RELEASE_APP_ID:
        description: 'GitHub App ID for authentication'
        required: false
      SEMANTIC_RELEASE_APP_PRIVATE_KEY:
        description: 'GitHub App private key for authentication'
        required: false

# default: least privileged permissions across all jobs
permissions:
  contents: read

jobs:
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    concurrency:
      group: semantic-release-${{ github.repository }}-${{ github.ref_name }}
      cancel-in-progress: false
    permissions:
      contents: write      # Required to push commits and tags
      id-token: write      # Required for GitHub's OIDC token
    outputs:
      new_version: ${{ steps.release.outputs.version }}
      released: ${{ steps.release.outputs.released }}
      tag: ${{ steps.release.outputs.tag }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ secrets.SEMANTIC_RELEASE_APP_ID }}
          private-key: ${{ secrets.SEMANTIC_RELEASE_APP_PRIVATE_KEY }}
        continue-on-error: true

      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0  # Full history needed for semantic release
          # Use GitHub App token, PAT, or default GITHUB_TOKEN
          token: ${{ steps.app-token.outputs.token || secrets.SEMANTIC_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Validate required secrets
        id: validate-secrets
        env:
          APP_TOKEN_OUTCOME: ${{ steps.app-token.outcome }}
        shell: bash
        run: |
          # Check if GitHub App token generation failed (indicates missing secrets)
          if [[ "${APP_TOKEN_OUTCOME}" == "failure" ]]; then
            echo "❌ ERROR: GitHub App token generation failed!"
            echo "Please configure authentication secrets:"
            echo "  1. SEMANTIC_RELEASE_APP_ID + SEMANTIC_RELEASE_APP_PRIVATE_KEY (GitHub App authentication)"
            echo "  2. OR SEMANTIC_RELEASE_TOKEN (Personal Access Token)"
            echo ""
            echo "Instructions:"
            echo "  - Go to repository Settings → Secrets and variables → Actions"
            echo "  - Click 'New repository secret' and add the required secret"
            exit 1
          fi

          if [[ "${APP_TOKEN_OUTCOME}" == "success" ]]; then
            echo "✅ GitHub App authentication configured"
          else
            echo "ℹ️ Using RELEASE_TOKEN or GITHUB_TOKEN for authentication"
          fi

      - name: Force branch to workflow sha
        run: |
          git reset --hard ${{ github.sha }}

      - name: Change to working directory
        if: inputs.working_directory != '.'
        env:
          WORKING_DIR: ${{ inputs.working_directory }}
        run: |
          cd "${WORKING_DIR}"

      - name: Python Semantic Release
        id: release
        uses: python-semantic-release/python-semantic-release@4d4cb0ab842247caea1963132c242c62aab1e4d5 # v10.4.1
        with:
          github_token: ${{ steps.app-token.outputs.token || secrets.SEMANTIC_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
          git_committer_name: "github-actions[bot]"
          git_committer_email: "actions@users.noreply.pinkroccade.ghe.com"
          # Force version bump for manual dispatch
          force: ${{ inputs.bump }}
          # Skip build since this is infrastructure, not a Python package
          build: false
          # Enable changelog generation
          changelog: true
          # Enable VCS (GitHub) release creation
          vcs_release: true
          # Enable commits if we have elevated permissions (App or PAT)
          commit: true
          # Working directory
          directory: ${{ inputs.working_directory }}
          # Increase verbosity for debugging
          verbosity: 2
