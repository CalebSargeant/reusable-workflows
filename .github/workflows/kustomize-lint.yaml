name: Kustomize Lint

on:
  workflow_call:
    inputs:
      runner:
        type: string
        description: 'The runner to use for the job'
        default: ubuntu-latest
        required: false
      k8s_directory:
        type: string
        description: 'Directory containing Kustomize files'
        required: false
        default: './k8s'
      kustomize_version:
        type: string
        description: 'Kustomize version to use'
        required: false
        default: 'latest'
      kubernetes_version:
        type: string
        description: 'Kubernetes version for validation (e.g., 1.32.0)'
        required: false
        default: '1.32.0'
      skip_yamllint:
        type: boolean
        description: 'Skip YAML linting'
        required: false
        default: false
      fail_on_yamllint:
        type: boolean
        description: 'Fail the workflow if yamllint finds issues'
        required: false
        default: false
      skip_kubeconform:
        type: boolean
        description: 'Skip kubeconform validation'
        required: false
        default: false
      skip_kubescore:
        type: boolean
        description: 'Skip kube-score validation'
        required: false
        default: false
      strict_validation:
        type: boolean
        description: 'Enable strict validation in kubeconform'
        required: false
        default: true

permissions:
  contents: read
  pull-requests: read

jobs:
  # Check if there are changes in the k8s directory
  check-changes:
    runs-on: ${{ inputs.runner }}
    outputs:
      k8s_changed: ${{ steps.filter.outputs.k8s }}
    steps:
      - name: 'Checkout'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: 'Normalize k8s directory path'
        id: normalize-path
        run: |
          # Remove leading ./ from path for dorny/paths-filter compatibility
          K8S_DIR="${{ inputs.k8s_directory }}"
          K8S_DIR="${K8S_DIR#./}"
          echo "normalized_path=${K8S_DIR}" >> "$GITHUB_OUTPUT"

      - name: 'Check for changes in k8s directory'
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            k8s:
              - '${{ steps.normalize-path.outputs.normalized_path }}/**'

  # Lint and validate Kustomize files
  lint:
    runs-on: ${{ inputs.runner }}
    needs: [check-changes]
    # Only run if there are changes in the k8s directory
    if: needs.check-changes.outputs.k8s_changed == 'true'
    steps:
      - name: 'Checkout'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: 'Setup Kustomize'
        uses: imranismail/setup-kustomize@2ba527d4d055ab63514ba50a99456fc35684947f # v2.1.0
        with:
          kustomize-version: ${{ inputs.kustomize_version }}

      - name: 'Setup Python for yamllint'
        if: ${{ !inputs.skip_yamllint }}
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.12'

      - name: 'Install yamllint'
        if: ${{ !inputs.skip_yamllint }}
        run: pip install yamllint==1.35.1

      - name: 'Lint YAML files'
        if: ${{ !inputs.skip_yamllint }}
        run: |
          # yamllint can be strict; by default we allow it to fail with warnings
          # Set fail_on_yamllint: true to make this a hard failure
          if [ "${{ inputs.fail_on_yamllint }}" == "true" ]; then
            yamllint "${{ inputs.k8s_directory }}/"
          else
            yamllint "${{ inputs.k8s_directory }}/" || echo "::warning::YAML linting found issues but continuing..."
          fi

      - name: 'Build Kustomize manifests'
        id: kustomize-build
        run: |
          # Find all kustomization.yaml files and build them
          find "${{ inputs.k8s_directory }}" \( -name 'kustomization.yaml' -o -name 'kustomization.yml' \) | while read -r kustomization_file; do
            kustomization_dir=$(dirname "$kustomization_file")
            echo "Building Kustomize in: $kustomization_dir"
            kustomize build "$kustomization_dir" >> rendered-manifests.yaml
            echo "---" >> rendered-manifests.yaml
          done
          
          if [ ! -s rendered-manifests.yaml ]; then
            echo "::error::No Kustomize manifests were built. Check if kustomization.yaml exists in ${{ inputs.k8s_directory }}"
            exit 1
          fi
          
          echo "Successfully built Kustomize manifests"

      - name: 'Validate with kubeconform'
        if: ${{ !inputs.skip_kubeconform }}
        run: |
          STRICT_FLAG=""
          if [ "${{ inputs.strict_validation }}" == "true" ]; then
            STRICT_FLAG="-strict"
          fi
          
          cat rendered-manifests.yaml | docker run --rm -i \
            ghcr.io/yannh/kubeconform:v0.6.7-alpine \
            $STRICT_FLAG \
            -summary \
            -kubernetes-version ${{ inputs.kubernetes_version }}

      - name: 'Validate with kube-score'
        if: ${{ !inputs.skip_kubescore }}
        run: |
          # kube-score expects version in vN.NN format, not N.NN.N
          K8S_VERSION_SHORT=$(echo "${{ inputs.kubernetes_version }}" | cut -d. -f1-2)
          if [[ ! "$K8S_VERSION_SHORT" =~ ^v ]]; then
            K8S_VERSION_SHORT="v${K8S_VERSION_SHORT}"
          fi
          
          cat rendered-manifests.yaml | docker run --rm -i \
            zegl/kube-score:v1.19.0 \
            score - \
            --kubernetes-version "$K8S_VERSION_SHORT" \
            --color always || echo "::warning::kube-score found issues but continuing..."

  # This job will always succeed if no changes detected
  # or if lint job succeeds. It serves as a status check.
  success:
    runs-on: ${{ inputs.runner }}
    needs: [check-changes, lint]
    if: always()
    steps:
      - name: 'Check lint status'
        run: |
          # Ensure change detection itself succeeded; otherwise, fail.
          if [ "${{ needs.check-changes.result }}" != "success" ]; then
            echo "✗ Change detection job 'check-changes' did not complete successfully (result: ${{ needs.check-changes.result }})"
            exit 1
          fi

          # If change detection succeeded and reported no changes, succeed.
          if [ "${{ needs.check-changes.outputs.k8s_changed }}" != "true" ]; then
            echo "✓ No changes detected in ${{ inputs.k8s_directory }}, skipping linting"
            exit 0
          fi
          
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "✓ Kustomize linting passed"
            exit 0
          elif [ "${{ needs.lint.result }}" == "skipped" ]; then
            echo "✓ Linting was skipped (no changes)"
            exit 0
          else
            echo "✗ Kustomize linting failed"
            exit 1
          fi
