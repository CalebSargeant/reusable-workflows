name: Security Scan

# Minimal security scanning workflow with dynamic language detection
# Only runs the scans needed based on what files changed
# Fast by default - enable additional scans in caller workflow if needed

on:
  workflow_call:
    inputs:
      runner:
        description: 'GitHub runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
      trivy_severity:
        description: 'Trivy severity levels to scan for'
        required: false
        type: string
        default: 'CRITICAL,HIGH'
      trivy_exit_code:
        description: 'Exit code when vulnerabilities are found (1 = fail, 0 = warn only)'
        required: false
        type: string
        default: '1'
      trivy_ignore_unfixed:
        description: 'Ignore unfixed vulnerabilities'
        required: false
        type: boolean
        default: true
      trivyignore_file:
        description: 'Path to trivyignore file for whitelisting known CVEs (only used if file exists)'
        required: false
        type: string
        default: '.trivyignore'
      trufflehog_exclude:
        description: 'Path to exclude file for ignoring known secrets (gitignore-style patterns)'
        required: false
        type: string
        default: ''
      semgrep_baseline:
        description: 'Path to semgrep baseline file (.semgrepignore) for ignoring known issues'
        required: false
        type: string
        default: ''
      # Optional scanners - disabled by default, caller must enable
      enable_sast:
        description: 'Enable Semgrep SAST scanning'
        required: false
        type: boolean
        default: true
      enable_license_scan:
        description: 'Enable license compliance scanning'
        required: false
        type: boolean
        default: false
      semgrep_config:
        description: 'Semgrep rules configuration'
        required: false
        type: string
        default: 'p/default p/security-audit p/secrets'
      checkov_skip_checks:
        description: 'Checkov checks to skip (comma-separated)'
        required: false
        type: string
        default: ''
      enable_sarif_upload:
        description: 'Enable SARIF upload to GitHub Security tab (requires GitHub Advanced Security, which is a paid feature for private repos)'
        required: false
        type: boolean
        default: true
    outputs:
      scan_skipped:
        description: 'Whether the scan was skipped due to no relevant changes'
        value: ${{ jobs.security-scan.outputs.scan_skipped }}

permissions:
  contents: read
  pull-requests: read
  security-events: write

jobs:
  security-scan:
    name: Security Scan
    runs-on: ${{ inputs.runner }}
    outputs:
      scan_skipped: ${{ steps.detect.outputs.any_changed != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0

      # ============================================
      # Dynamic Language/File Detection
      # ============================================
      - name: Detect changed files and languages
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: detect
        with:
          filters: |
            any_changed:
              - '**/*'
            python:
              - '**/*.py'
              - 'requirements.txt'
              - 'pyproject.toml'
              - 'poetry.lock'
              - 'Pipfile'
              - 'Pipfile.lock'
              - 'setup.py'
              - 'setup.cfg'
            go:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
            javascript:
              - '**/*.js'
              - '**/*.jsx'
              - '**/*.ts'
              - '**/*.tsx'
              - '**/*.mjs'
              - '**/*.cjs'
              - 'package.json'
              - 'package-lock.json'
              - 'yarn.lock'
              - 'pnpm-lock.yaml'
            iac:
              - '**/*.tf'
              - '**/*.tfvars'
              - '**/*.hcl'
              - '**/k8s/**'
              - '**/kubernetes/**'
              - '**/kustomize/**'
              - '**/helm/**'
              - '**/*.yaml'
              - '**/*.yml'

      - name: Detection summary
        run: |
          echo "## ðŸ” Detected Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Language/Type | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ steps.detect.outputs.python }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript/TypeScript | ${{ steps.detect.outputs.javascript }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Go | ${{ steps.detect.outputs.go }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IaC (Terraform/K8s) | ${{ steps.detect.outputs.iac }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Skip if no changes
        if: steps.detect.outputs.any_changed != 'true'
        run: |
          echo "## â­ï¸ Security Scan Skipped" >> $GITHUB_STEP_SUMMARY
          echo "No relevant file changes detected." >> $GITHUB_STEP_SUMMARY
          echo "No changes detected, skipping security scan"

      # ============================================
      # CORE: Trivy Vulnerability Scan (always runs)
      # ============================================
      - name: Check for trivyignore file
        id: trivyignore
        run: |
          if [ -f "${{ inputs.trivyignore_file }}" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Found ${{ inputs.trivyignore_file }}"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No ${{ inputs.trivyignore_file }} found, skipping ignore file"
          fi

      - name: Run Trivy vulnerability scanner (with ignore file)
        id: trivy-scan
        if: steps.detect.outputs.any_changed == 'true' && steps.trivyignore.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # 0.30.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln'
          severity: ${{ inputs.trivy_severity }}
          exit-code: ${{ inputs.trivy_exit_code }}
          ignore-unfixed: ${{ inputs.trivy_ignore_unfixed }}
          skip-dirs: 'node_modules,.git,vendor'
          trivyignores: ${{ inputs.trivyignore_file }}
          format: 'table'
        continue-on-error: true

      - name: Run Trivy vulnerability scanner (without ignore file)
        id: trivy-scan-no-ignore
        if: steps.detect.outputs.any_changed == 'true' && steps.trivyignore.outputs.exists != 'true'
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # 0.30.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln'
          severity: ${{ inputs.trivy_severity }}
          exit-code: ${{ inputs.trivy_exit_code }}
          ignore-unfixed: ${{ inputs.trivy_ignore_unfixed }}
          skip-dirs: 'node_modules,.git,vendor'
          format: 'table'
        continue-on-error: true

      - name: Trivy SARIF output (with ignore file)
        if: steps.detect.outputs.any_changed == 'true' && inputs.enable_sarif_upload && steps.trivyignore.outputs.exists == 'true' && always()
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # 0.30.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln'
          severity: ${{ inputs.trivy_severity }}
          exit-code: '0'
          ignore-unfixed: ${{ inputs.trivy_ignore_unfixed }}
          skip-dirs: 'node_modules,.git,vendor'
          trivyignores: ${{ inputs.trivyignore_file }}
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Trivy SARIF output (without ignore file)
        if: steps.detect.outputs.any_changed == 'true' && inputs.enable_sarif_upload && steps.trivyignore.outputs.exists != 'true' && always()
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # 0.30.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln'
          severity: ${{ inputs.trivy_severity }}
          exit-code: '0'
          ignore-unfixed: ${{ inputs.trivy_ignore_unfixed }}
          skip-dirs: 'node_modules,.git,vendor'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy SARIF
        if: steps.detect.outputs.any_changed == 'true' && inputs.enable_sarif_upload && always()
        uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3.4.32.32.4.32.3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'
        continue-on-error: true

      # ============================================
      # CORE: TruffleHog Secret Detection (always runs)
      # ============================================
      - name: Check for TruffleHog exclude file
        id: trufflehog-baseline
        run: |
          if [ -n "${{ inputs.trufflehog_exclude }}" ] && [ -f "${{ inputs.trufflehog_exclude }}" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Found ${{ inputs.trufflehog_exclude }}"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run TruffleHog secret detection
        id: trufflehog-scan
        if: steps.detect.outputs.any_changed == 'true'
        uses: trufflesecurity/trufflehog@6961f2bace57ab32b23b3ba40f8f420f6bc7e004 # v3.93.3
        with:
          extra_args: --only-verified ${{ steps.trufflehog-baseline.outputs.exists == 'true' && format('--exclude-paths={0}', inputs.trufflehog_exclude) || '' }}
        continue-on-error: true

      # ============================================
      # DYNAMIC: Python Security (pip-audit)
      # ============================================
      - name: Run pip-audit (Python detected)
        if: steps.detect.outputs.any_changed == 'true' && steps.detect.outputs.python == 'true'
        uses: pypa/gh-action-pip-audit@1220774d901786e6f652ae159f7b6bc8fea6d266 # v1.1.0
        with:
          vulnerability-service: osv
        continue-on-error: true

      # ============================================
      # DYNAMIC: JavaScript/Node.js Security (npm audit)
      # ============================================
      - name: Setup Node.js
        if: steps.detect.outputs.any_changed == 'true' && steps.detect.outputs.javascript == 'true'
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 'lts/*'

      - name: Run npm audit (JavaScript detected)
        if: steps.detect.outputs.any_changed == 'true' && steps.detect.outputs.javascript == 'true'
        run: |
          if [ -f "package-lock.json" ]; then
            echo "Running npm audit..."
            npm audit --audit-level=high
          elif [ -f "yarn.lock" ]; then
            echo "Running yarn audit..."
            npm install -g yarn
            yarn audit --level high
          elif [ -f "pnpm-lock.yaml" ]; then
            echo "Running pnpm audit..."
            npm install -g pnpm
            pnpm audit --audit-level high
          else
            echo "No lock file found, skipping audit"
          fi
        continue-on-error: true

      # ============================================
      # DYNAMIC: Go Security (govulncheck)
      # ============================================
      - name: Setup Go
        if: steps.detect.outputs.any_changed == 'true' && steps.detect.outputs.go == 'true'
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: 'stable'
          cache: false

      - name: Run govulncheck (Go detected)
        if: steps.detect.outputs.any_changed == 'true' && steps.detect.outputs.go == 'true'
        uses: golang/govulncheck-action@b625fbe08f3bccbe446d94fbf87fcc875a4f50ee # v1.0.4
        with:
          go-version-input: 'stable'
          check-latest: true
        continue-on-error: true

      # ============================================
      # CORE: Semgrep SAST (enabled by default)
      # ============================================
      - name: Setup Semgrep
        if: steps.detect.outputs.any_changed == 'true' && inputs.enable_sast
        run: pip3 install semgrep==${{ env.SEMGREP_VERSION }}
        env:
          SEMGREP_VERSION: '1.151.0'

      - name: Run Semgrep SAST
        id: semgrep-scan
        if: steps.detect.outputs.any_changed == 'true' && inputs.enable_sast
        run: |
          # Convert space-separated configs to multiple --config flags
          CONFIGS=""
          for config in ${{ inputs.semgrep_config }}; do
            CONFIGS="$CONFIGS --config $config"
          done

          semgrep scan --sarif $CONFIGS --output semgrep.sarif || exit_code=$?
          # Semgrep exit codes: 0=no findings, 1=findings, 2+=error
          # We only fail on findings (exit 1), not on errors (exit 2+)
          if [ "${exit_code:-0}" -eq 1 ]; then
            exit 1
          elif [ "${exit_code:-0}" -gt 1 ]; then
            echo "âš ï¸ Semgrep encountered an error (exit code $exit_code) but continuing"
            exit 0
          fi
        continue-on-error: true

      - name: Upload Semgrep SARIF
        if: steps.detect.outputs.any_changed == 'true' && inputs.enable_sast && inputs.enable_sarif_upload && always()
        uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3.4.32.32.4.32.3
        with:
          sarif_file: 'semgrep.sarif'
          category: 'semgrep'
        continue-on-error: true

      # ============================================
      # DYNAMIC: Checkov IaC Scan (Terraform/K8s/Docker)
      # ============================================
      - name: Check for Checkov config file
        id: checkov-config
        run: |
          if [ -f ".checkov.yaml" ] || [ -f ".checkov.yml" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            if [ -f ".checkov.yaml" ]; then
              echo "file=.checkov.yaml" >> "$GITHUB_OUTPUT"
              echo "Found .checkov.yaml"
            else
              echo "file=.checkov.yml" >> "$GITHUB_OUTPUT"
              echo "Found .checkov.yml"
            fi
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No Checkov config file found"
          fi

      - name: Run Checkov IaC scan (IaC detected)
        id: checkov-scan
        if: steps.detect.outputs.any_changed == 'true' && steps.detect.outputs.iac == 'true'
        uses: bridgecrewio/checkov-action@b3c44b4437c93549fc8cfaef9208497ba4955d39 # v12.3081.0
        with:
          directory: .
          framework: all
          config_file: ${{ steps.checkov-config.outputs.exists == 'true' && steps.checkov-config.outputs.file || '' }}
          skip_check: ${{ inputs.checkov_skip_checks }}
          output_format: ${{ inputs.enable_sarif_upload && 'sarif' || 'cli' }}
          output_file_path: ${{ inputs.enable_sarif_upload && 'checkov-results.sarif' || '' }}
          soft_fail: false
        continue-on-error: true

      - name: Upload Checkov SARIF
        if: steps.detect.outputs.any_changed == 'true' && steps.detect.outputs.iac == 'true' && inputs.enable_sarif_upload && always()
        uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3.4.32.32.4.32.3
        with:
          sarif_file: 'checkov-results.sarif'
          category: 'checkov'
        continue-on-error: true

      # ============================================
      # OPTIONAL: License Compliance (caller must enable)
      # ============================================
      - name: Run license scan
        if: steps.detect.outputs.any_changed == 'true' && inputs.enable_license_scan
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # 0.30.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'license'
          exit-code: '1'
          severity: 'UNKNOWN,HIGH,CRITICAL'
        continue-on-error: true

      # ============================================
      # Final Status Check
      # ============================================
      - name: Check for security findings
        if: steps.detect.outputs.any_changed == 'true' && always()
        run: |
          FAILED=false

          if [ "${{ steps.trivy-scan.outcome }}" == "failure" ] || [ "${{ steps.trivy-scan-no-ignore.outcome }}" == "failure" ]; then
            echo "âŒ Trivy found vulnerabilities"
            FAILED=true
          fi

          if [ "${{ steps.trufflehog-scan.outcome }}" == "failure" ]; then
            echo "âŒ TruffleHog found secrets"
            FAILED=true
          fi

          if [ "${{ steps.semgrep-scan.outcome }}" == "failure" ]; then
            echo "âŒ Semgrep found security issues"
            FAILED=true
          fi

          if [ "${{ steps.checkov-scan.outcome }}" == "failure" ]; then
            echo "âŒ Checkov found IaC security issues"
            FAILED=true
          fi

          if [ "$FAILED" == "true" ]; then
            echo ""
            echo "âš ï¸ Security scans found issues - failing job"
            exit 1
          else
            echo "âœ… All security scans passed"
          fi

      # ============================================
      # Summary
      # ============================================
      - name: Security Scan Summary
        if: steps.detect.outputs.any_changed == 'true'
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Core Scans (always run)" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Vulnerability Scan | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| TruffleHog Secret Detection | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.enable_sast }}" == "true" ]; then
            echo "| Semgrep SAST | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Semgrep SAST | â­ï¸ Disabled |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Dynamic Scans (based on detected files)" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.detect.outputs.python }}" == "true" ]; then
            echo "| pip-audit (Python) | âœ… Ran |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.detect.outputs.javascript }}" == "true" ]; then
            echo "| npm/yarn/pnpm audit (JavaScript) | âœ… Ran |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.detect.outputs.go }}" == "true" ]; then
            echo "| govulncheck (Go) | âœ… Ran |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.detect.outputs.iac }}" == "true" ]; then
            echo "| Checkov IaC | âœ… Ran |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.detect.outputs.python }}" != "true" ] && \
             [ "${{ steps.detect.outputs.javascript }}" != "true" ] && \
             [ "${{ steps.detect.outputs.go }}" != "true" ] && \
             [ "${{ steps.detect.outputs.iac }}" != "true" ]; then
            echo "| (no language-specific scans needed) | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Optional Scans (caller-enabled)" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.enable_license_scan }}" == "true" ]; then
            echo "| License Scan | âœ… Ran |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| License Scan | â­ï¸ Not enabled |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Security Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Scan results are visible in step logs above" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.enable_sarif_upload }}" == "true" ]; then
            echo "- SARIF results uploaded to Security tab (requires GHAS for private repos)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- SARIF upload disabled - all findings are shown in logs above (GitHub Advanced Security not required)" >> $GITHUB_STEP_SUMMARY
          fi

